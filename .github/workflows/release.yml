name: Release

on:
  push:
    tags: ['v*.*.*']

permissions:
  contents: write
  packages: read

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest
    outputs:
      notes_file: ${{ steps.changelog.outputs.notes_file }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          set -euo pipefail

          PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${GITHUB_REF_NAME}$" | head -1 || true)
          echo "Previous tag: ${PREV_TAG:-<none>}"

          if [[ -n "${PREV_TAG}" ]]; then
            LOG_RANGE="${PREV_TAG}..${GITHUB_REF_NAME}"
          else
            LOG_RANGE="${GITHUB_REF_NAME}"
          fi

          collect_commits() {
            local pattern="$1"
            local commits
            commits=$(git log "${LOG_RANGE}" --oneline --grep="${pattern}" || true)
            if [[ -z "${commits}" ]]; then
              echo "æ— "
            else
              echo "${commits}" | sed 's/^/- /'
            fi
          }

          FEATURES=$(collect_commits '^feat')
          FIXES=$(collect_commits '^fix')
          BREAKS=$(collect_commits 'BREAKING CHANGE')

          {
            echo "## âš ï¸ Breaking Changes"
            echo "${BREAKS}"
            echo ""
            echo "## âœ¨ New Features"
            echo "${FEATURES}"
            echo ""
            echo "## ðŸ› Bug Fixes"
            echo "${FIXES}"
            echo ""
            echo "## ðŸ³ Docker é•œåƒ"
            echo '```'
            echo "ghcr.io/${GITHUB_REPOSITORY_OWNER}/nodepass-hub:${GITHUB_REF_NAME}"
            echo "ghcr.io/${GITHUB_REPOSITORY_OWNER}/nodepass-frontend:${GITHUB_REF_NAME}"
            echo "ghcr.io/${GITHUB_REPOSITORY_OWNER}/nodepass-agent:${GITHUB_REF_NAME}"
            echo '```'
            echo ""
            echo "## ðŸš€ ä¸€é”®å‡çº§"
            echo '```bash'
            echo "# åœ¨å·²éƒ¨ç½²çš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œ"
            echo "curl -fsSL https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/deploy/upgrade.sh | bash -s ${GITHUB_REF_NAME}"
            echo '```'
          } > RELEASE_NOTES.md

          echo "notes_file=RELEASE_NOTES.md" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: RELEASE_NOTES.md
          retention-days: 1

  build-release-assets:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
          - goos: linux
            goarch: arm
            goarm: 7
            suffix: linux-armv7

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build Hub binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
        run: |
          mkdir -p bin
          make hub-build-prod \
            VERSION=${{ github.ref_name }} \
            COMMIT=${{ github.sha }}
          mv bin/nodepass-hub bin/nodepass-hub-${{ matrix.suffix }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hub-${{ matrix.suffix }}
          path: bin/nodepass-hub-${{ matrix.suffix }}
          retention-days: 1

  create-release:
    runs-on: ubuntu-latest
    needs: [generate-release-notes, build-release-assets]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      - uses: actions/download-artifact@v4
        with:
          pattern: hub-*
          path: bin
          merge-multiple: true

      - name: Generate checksums
        run: |
          set -euo pipefail
          sha256sum bin/nodepass-hub-* > checksums.txt

      - uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
          files: |
            bin/nodepass-hub-linux-amd64
            bin/nodepass-hub-linux-arm64
            bin/nodepass-hub-linux-armv7
            checksums.txt
            deploy/setup.sh
          generate_release_notes: false
          make_latest: true
