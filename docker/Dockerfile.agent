FROM alpine AS embed-prep
ARG TARGETARCH
ARG TARGETVARIANT
ARG NODEPASS_VERSION=latest
ARG NODEPASS_UPSTREAM=nodepass-project/nodepass
RUN apk add --no-cache ca-certificates wget
RUN set -eux; \
    ARCH_SUFFIX="${TARGETARCH}"; \
    if [ "${TARGETARCH}" = "arm" ]; then ARCH_SUFFIX="armv7"; fi; \
    wget -O /nodepass "https://github.com/${NODEPASS_UPSTREAM}/releases/download/${NODEPASS_VERSION}/nodepass-linux-${ARCH_SUFFIX}"; \
    chmod +x /nodepass

FROM golang:1.22-alpine AS go-deps
WORKDIR /app
COPY nodepass-agent/go.mod nodepass-agent/go.sum ./
RUN go mod download

FROM go-deps AS builder
WORKDIR /app
ARG TARGETARCH
ARG TARGETVARIANT
ARG VERSION=dev
ARG COMMIT=unknown
COPY nodepass-agent/ .
COPY --from=embed-prep /nodepass /tmp/nodepass
RUN set -eux; \
    EMBED_ARCH="${TARGETARCH}"; \
    GOARM_VALUE=""; \
    if [ "${TARGETARCH}" = "arm" ]; then \
      EMBED_ARCH="armv7"; \
      GOARM_VALUE="${TARGETVARIANT#v}"; \
      if [ -z "${GOARM_VALUE}" ]; then GOARM_VALUE="7"; fi; \
    fi; \
    cp /tmp/nodepass "./assets/nodepass-linux-${EMBED_ARCH}"; \
    chmod +x "./assets/nodepass-linux-${EMBED_ARCH}"; \
    if [ "${TARGETARCH}" = "arm" ]; then export GOARM="${GOARM_VALUE}"; fi; \
    CGO_ENABLED=0 GOOS=linux GOARCH="${TARGETARCH}" go build \
      -ldflags="-s -w -X main.Version=${VERSION} -X main.Commit=${COMMIT}" \
      -o /nodepass-agent ./cmd/agent

FROM gcr.io/distroless/static-debian12 AS final
COPY --from=builder /nodepass-agent /nodepass-agent
USER nonroot:nonroot
ENV HUB_WS_URL=""
ENV AGENT_ID=""
ENV AGENT_TOKEN=""
HEALTHCHECK --interval=60s --timeout=10s --start-period=30s \
  CMD ["/nodepass-agent", "healthcheck"]
ENTRYPOINT ["/nodepass-agent"]

# This Dockerfile is intended for docker buildx multi-arch builds:
# docker buildx build \
#   --platform linux/amd64,linux/arm64,linux/arm/v7 \
#   --build-arg NODEPASS_VERSION=v1.x.x \
#   --build-arg VERSION=$(git describe --tags) \
#   -f docker/Dockerfile.agent \
#   -t ghcr.io/adambear22/nodepass-agent:latest \
#   --push .
