#!/usr/bin/env bash
set -euo pipefail

AGENT_ID="{{ .AgentID }}"
AGENT_TOKEN="{{ .AgentToken }}"
AGENT_AUTH_TOKEN="{{ .AgentAuthToken }}"
HUB_WS_URL="{{ .HubWSURL }}"
AGENT_VERSION="{{ .AgentVersion }}"
ARCH="{{ .Arch }}"
DOWNLOAD_BASE_URL="{{ .DownloadBaseURL }}"
DEPLOY_PROGRESS_URL="{{ .DeployProgressURL }}"
INSTALL_SCRIPT_URL="{{ .InstallScriptURL }}"

INSTALL_DIR="/opt/nodepass-agent"
BINARY_PATH="${INSTALL_DIR}/bin/nodepass-agent"
CONFIG_PATH="${INSTALL_DIR}/agent.conf"
SERVICE_PATH="/etc/systemd/system/nodepass-agent.service"
SERVICE_NAME="nodepass-agent"
MASTER_PORT="${MASTER_PORT:-9090}"

report_progress() {
  local step="$1"
  local progress="$2"
  local message="$3"

  curl -fsS -X POST "${DEPLOY_PROGRESS_URL}" \
    -H "Content-Type: application/json" \
    -H "X-Agent-ID: ${AGENT_ID}" \
    -H "X-Agent-Token: ${AGENT_AUTH_TOKEN}" \
    --data "{\"agent_id\":\"${AGENT_ID}\",\"step\":\"${step}\",\"progress\":${progress},\"message\":\"${message}\"}" \
    >/dev/null || true
}

ensure_dependencies() {
  command -v curl >/dev/null 2>&1 || {
    echo "curl is required"
    exit 1
  }
  command -v systemctl >/dev/null 2>&1 || {
    echo "systemctl is required"
    exit 1
  }
  command -v openssl >/dev/null 2>&1 || {
    echo "openssl is required"
    exit 1
  }
}

verify_checksum() {
  local source_path="${BASH_SOURCE[0]:-$0}"
  if [[ -z "${source_path}" || ! -r "${source_path}" ]]; then
    if [[ -n "${INSTALL_SCRIPT_URL}" && -z "${NODEPASS_INSTALL_REFETCHED:-}" ]]; then
      local retry_script
      retry_script="$(mktemp /tmp/nodepass-agent-install.XXXXXX.sh)"
      if curl -fsSL "${INSTALL_SCRIPT_URL}" -o "${retry_script}"; then
        chmod 700 "${retry_script}"
        NODEPASS_INSTALL_REFETCHED=1 exec bash "${retry_script}"
      fi
      rm -f "${retry_script}"
    fi

    echo "unable to read script source for checksum verification" >&2
    if [[ -n "${INSTALL_SCRIPT_URL}" ]]; then
      echo "retry with: bash <(curl -fsSL \"${INSTALL_SCRIPT_URL}\")" >&2
    fi
    exit 1
  fi

  local expected
  expected="$(grep -m 1 '^# nodepass-checksum:' "${source_path}" | awk '{print $3}')"
  if [[ -z "${expected}" ]]; then
    echo "missing script checksum header"
    exit 1
  fi

  local actual
  actual="$(grep -v '^# nodepass-checksum:' "${source_path}" | openssl dgst -sha256 -hmac "${AGENT_TOKEN}" | awk '{print $2}')"
  if [[ -z "${actual}" || "${actual}" != "${expected}" ]]; then
    echo "script checksum verification failed"
    exit 1
  fi
}

build_download_url() {
  local normalized_arch="${ARCH}"
  case "${normalized_arch}" in
    armv7|arm/v7|arm) normalized_arch="armv7" ;;
    aarch64) normalized_arch="arm64" ;;
    x86_64) normalized_arch="amd64" ;;
  esac

  local file_name="nodepass-agent-${AGENT_VERSION}-linux-${normalized_arch}"
  echo "${DOWNLOAD_BASE_URL%/}/${file_name}"
}

install_binary() {
  local download_url
  download_url="$(build_download_url)"

  mkdir -p "${INSTALL_DIR}/bin"
  report_progress "download_binary" 20 "downloading agent binary"

  curl -fL -C - "${download_url}" -o "${BINARY_PATH}"
  chmod +x "${BINARY_PATH}"

  report_progress "binary_ready" 40 "agent binary downloaded"
}

write_base_config() {
  report_progress "write_config" 50 "writing base agent config"

  cat > "${CONFIG_PATH}" <<CONFIG
# NodePass Agent configuration
[agent]
agent_id = ${AGENT_ID}
panel_url = ${HUB_WS_URL}
deploy_token = ${AGENT_TOKEN}
connect_addr =
egress_network =

[nodepass]
# Filled by agent automatically on first start.
DEPLOY_DEFAULT_MASTER_ADDR =
DEPLOY_DEFAULT_MASTER_API_KEY =
master_port = ${MASTER_PORT}
start_timeout = 30

[panel]
heartbeat_interval = 30
command_timeout = 30
CONFIG

  chmod 600 "${CONFIG_PATH}"
}

write_service_file() {
  report_progress "write_service" 65 "writing systemd service"

  cat > "${SERVICE_PATH}" <<SERVICE
[Unit]
Description=NodePass Agent
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
WorkingDirectory=${INSTALL_DIR}
ExecStart=${BINARY_PATH} --config ${CONFIG_PATH} --workdir ${INSTALL_DIR}
Restart=on-failure
RestartSec=5s
KillMode=process
TimeoutStopSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=nodepass-agent

[Install]
WantedBy=multi-user.target
SERVICE

  report_progress "service_written" 80 "systemd service file created"
}

wait_for_credentials() {
  local timeout=60
  local elapsed=0
  local addr=""
  local key=""

  while [[ "${elapsed}" -lt "${timeout}" ]]; do
    addr="$(grep '^DEPLOY_DEFAULT_MASTER_ADDR' "${CONFIG_PATH}" | awk -F= '{print $2}' | tr -d '[:space:]' || true)"
    key="$(grep '^DEPLOY_DEFAULT_MASTER_API_KEY' "${CONFIG_PATH}" | awk -F= '{print $2}' | tr -d '[:space:]' || true)"
    if [[ -n "${addr}" && -n "${key}" ]]; then
      report_progress "credentials_ready" 95 "credentials written to agent.conf"
      return 0
    fi

    sleep 2
    elapsed=$((elapsed + 2))
  done

  echo "credentials not written within ${timeout}s" >&2
  echo "check logs: journalctl -u ${SERVICE_NAME} -n 50" >&2
  return 1
}

start_service() {
  report_progress "start_service" 85 "starting service"

  systemctl daemon-reload
  systemctl enable --now "${SERVICE_NAME}"

  report_progress "wait_connected" 90 "service started, waiting for credentials"
}

main() {
  ensure_dependencies
  verify_checksum
  report_progress "prepare" 5 "prepare installation"
  install_binary
  write_base_config
  write_service_file
  start_service
  wait_for_credentials
  report_progress "done" 100 "installation completed"
}

main "$@"
